---
title: "graphic_design_is_my_passion"
author: "Dave Lovell"
date: "25/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("readr")
library("here")
library("magrittr")
library("dplyr")
library("tidyr")
library("ggplot2")
library("gganimate")
library("stringr")
library("carutools")
library("Cairo")
```

### Read the CSV

```{r readCSV}
visData <- read_csv(here("activities.csv"))

head(visData)
```

### Tidy it up

```{r tidyData}
visData %<>% filter(!is.na(activity))
```

### status_split function

This generates two variables from `visData[["status"]]`, which correspond to the pre/post lockdown realities.

```{r status_split function}
status_split <- function(statusValue) {
  
  statusValue %<>% as.character
  
  if (statusValue == "ended") {
    beforeStatus <- "existent"
    afterStatus <- "non-existent"
  } else if (statusValue == "started") {
    beforeStatus <- "non-existent"
    afterStatus <- "non-existent"
  } else if (statusValue == "stayed the same") {
    beforeStatus <- "existent"
    afterStatus <- "existent"
  } else if (statusValue == "changed") {
    beforeStatus <- "existent"
    afterStatus <- "different"
  } else {
    stop("Activity status must be one of: 'started', ended', 'changed' or 'stayed the same'")
  }
  
  statusTibble <- tibble(beforeStatus = beforeStatus,
                         afterStatus = afterStatus) %>%
    mutate(across(everything(),
                  ~ factor(.,levels = rev(c("existent", "different", "non-existent")),
                           ordered = TRUE)
                  ))
  
  return(statusTibble)
    
}
```

Some examples:

```{r exemplifying function, collapse = TRUE}
status_split("started")
status_split("ended")
status_split("stayed the same")
status_split("changed")

try(status_split("Epstein didn't kill himself"))
```

### Summarise Data

To get new `beforeStatus` and `afterStatus` variables

```{r summariseData}
visData %<>% group_by(type, number, activity)
visData %<>% rowwise
visData %<>% summarise(status_split(status))
visData %<>% ungroup

visData
```

Now `pivot_longer` so we can `facet_wrap` the ggplobject.

Doing a few things here:

* making a name/value column pair from `beforeStatus` and `afterStatus`
* The names column is the 'before' and 'after', extracted from column names
  * This column is called 'time'
* The values column is called 'status'
* The time column is an ordered factor

```{r pivot_longer_this_data}
visData %<>% pivot_longer(all_of(c("beforeStatus", "afterStatus")),
                         names_to = "time",
                         names_pattern = "(.*)(?=Status)",
                         values_to = "status",
                         names_transform = 
                           list(time = 
                                  ~ factor(., levels = c("before", "after"), 
                                           ordered = TRUE)))
visData
```

### Visualise

```{r visualiseIt}
head(visData,2)
### Visualise non-existence mimeticly ;)
# visData %<>% filter(status != "non-existent")

### gganimate requires an expicit zero value to transition correctly - thus also requires stat = "identity" in this instance
visData %<>% group_by(type, time)
visData %<>% summarise(existent = sum(status == "existent"),
                      different = sum(status == "different")) %>% 
  pivot_longer(all_of(c("existent", "different")),
                      names_to = "status",
                      values_to = "occurence")

donutHole <- 0.5

make_radial <- function(visData) {
  
  visData %<>% group_by(type, time)
  visData %<>% arrange(type, time, occurence)
  visData %>%
    mutate(
      occurence = 
    ### clever snippet gets heigths for big circle
    occurence %>% 
    {tmp <- sqrt(cumsum(c(donutHole, .)))
    tmp <- tmp - c(0, tmp[-length(tmp)])
    tmp[-1]})
}

visData %<>% make_radial

visData %<>% mutate(type = 
                      type %>% 
                      str_replace_all("_", " ") %>% 
                      str_to_title())
visData %<>% mutate(status = 
                      status %>% 
                      fct_recode("Consistent activity" = "existent", 
                                 "Modified activity" = "different"))
visData %<>% rename("Activity status:" = "status")

q <- ggplot(visData, aes(
  x = type,
  y = occurence
)) +
  geom_bar(stat = "identity",
           position = "stack",
           width = 1.01,
           aes(group = paste0(type, `Activity status:`),
               fill = `Activity status:`,
               col = `Activity status:`)) +
  coord_polar(theta = "x") +
  theme_minimal() +
  scale_y_continuous(breaks = NULL, limits = c(- donutHole, NA)) +
  scale_fill_manual(values = rev(c(ct_darkteal(), ct_cyan()))) +
  scale_color_manual(values = rev(c(ct_darkteal(), ct_cyan()))) +
  xlab(NULL) +
  ylab(NULL) +
  theme(axis.text.x = element_text(size = 15,
                                   angle = 
            360 / (2 * pi) * seq(2 * pi - pi / 7, pi / 7, len = 7)))

anim <- q +
  transition_states(time,
                      transition_length = 1,
                      state_length = 1) +
  ease_aes("sine-in-out") +
  ggtitle("Activities {closest_state} lockdown")

animate(anim, nframes = 200, fps = 66, type = "cairo")

```